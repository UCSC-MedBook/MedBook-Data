<template name="editSubmission">
  {{print "editSubmission this:" this}}

  {{#if this}} {{! if no data, invalid WranglerDocuments _id in URL }}

    {{> addFiles}}

    <hr />

    {{! TODO: add objects manually}}

    {{#if subscriptionsReallyReady}}
      {{#if hasDocuments}}
        {{#if classifySubmissionType this._id}}
          {{> reviewWranglerDocuments}}
          <hr />
          {{> optionsAndSubmit}}
        {{else}}
          <span class="help-block">
            Multiple submission types detected:
            <ul>
              {{#each getSubmissionTypes}}
                <li>{{this}}</li>
              {{/each}}
            </ul>
            Please submit each type of new document seperately.
          </span>
        {{/if}}
      {{else}}
        <span class="help-block">
          {{#if hasFiles}}
            {{#if hasCompletedFile}}
              You have uploaded a file, but no documents were created...
              Maybe you uploaded a blank file?
            {{else}}
              {{#if hasProcessingFile}}
                Your files are being processed...
              {{else}}
                {{#if hasUploadingFile}}
                  Your files are uploading...
                {{else}}
                  Please correct errors to continue.
                {{/if}}
              {{/if}}
            {{/if}}
          {{else}}
            Add files or objects to continue
          {{/if}}
        </span>
      {{/if}}
    {{else}}
      <div class="relative-spinner" style="height: 300px;">
        {{> spinner}}
      </div>
    {{/if}}
  {{else}}
    {{! loading handled in the router }}
    {{> pageNotFound}}
  {{/if}}
</template>

<template name="addFiles">
  <h2>
    {{#if compare status "editing"}}
      Add files
    {{else}}
      Files
    {{/if}}
  </h2>

  {{#if shouldBeFullWidth}}
    {{> listFiles}}
  {{else}}
    <div class="row click-outside-to-unselect">
      <div class="col-md-8">
        {{> listFiles}}
      </div>
      <div class="col-md-4">
        {{#if editing_file}}
          {{> editFileOptions}}
        {{else}}
          <span class="help-block center-text">
            Select a file to edit.
          </span>
        {{/if}}
      </div>
    </div>
  {{/if}}
</template>

<template name="listFiles">
  <ul class="list-group">
    {{#each getFiles}}
      <li class="list-group-item edit-this-file
          {{fileContextualClass}}
          {{activeClass}}">
        <h5 class="list-group-item-heading"> {{! what a large h5...}}
          <i class="glyphicon glyphicon-file"></i>

          {{blob_name}}

          <span class="pull-right">
            <span class="badge">
              {{#if compare status "done"}}
                processed
              {{else}}
                {{status}}
              {{/if}}
            </span>
            {{#if isEditable}}
              <button class="remove-this-file btn btn-xs btn-warning">
                <span class="sr-only">Remove file</span>
                <span class="glyphicon glyphicon-trash"></span>
              </button>
            {{/if}}
          </span>
        </h5>

        {{#if isDefined file_type}}
          <p class="list-group-item-text">
            <span class="blank-glyphicon-to-left">
              Forced file type: {{file_type}}
            </span>
          </p>
        {{/if}}

        {{#if compare status "error"}}
          <p class="list-group-item-text">
            <span class="blank-glyphicon-to-left">
              {{error_description}}
            </span>
          </p>
        {{/if}}

        {{#if compare status "uploading"}}
          <p class="list-group-item-text">
            {{#with FS.GetFile "blobs" blob_id}}
              {{> FS.UploadProgressBar bootstrap=true
                  class='progress-bar-striped active'
                  showPercent=true}}
            {{/with}}
          </p>
        {{/if}}
      </li>
    {{/each}}

    {{#if compare status "editing"}}
      {{> uploadFilesListItem}}
    {{/if}}
  </ul>
</template>

<template name="uploadFilesListItem">
  {{! the last list item: for adding files/objects}}
  <li class="list-group-item">
    <div class="row">
      {{! upload local files}}
      <div class="col-xs-6">
        <span class="btn btn-default btn-file fill-width">
          Upload local files
          <input id="upload-files-input" type="file" multiple>
        </span>
      </div>

      {{! add from the web}}
      <div class="col-xs-6">
        <form class="add-from-web-form">
          <div class="input-group">
            <input name="urlInput" type="text" class="form-control"
                placeholder="Enter URL">
            <span class="input-group-btn">
              <button class="btn btn-default" type="submit">
                Add
              </button>
            </span>
          </div>
        </form>
      </div>

      {{! TODO: add manually}}
      <!-- <div class="col-md-4 btn-group display-block">
        <button class="btn btn-default dropdown-toggle fill-width"
            type="button" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
          Add manually <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li class="add-superpathway"><a href="#">Superpathway</a></li>
          <li><a href="#">Another action</a></li>
          <li class="disabled"><a href="#">Something else here</a></li>
          <li role="separator" class="divider"></li>
          <li><a href="#">Separated link</a></li>
        </ul>
      </div> -->
    </div>
  </li>
</template>

<template name="editFileOptions">
  {{#if stillProcessing}}
    <span class="help-block center-text">
      Note: changes will take effect after current processing job is finished
    </span>
  {{/if}}
  {{#autoForm id="edit-file" schema=fileTypeSchema doc=currentEditingFile}}
    {{> afQuickField name="file_type"
        firstOption="Auto"}}
    {{#if afFieldValueIs name="file_type" value="gene_expression"}}
      {{> afQuickField name="normalization"}}
    {{/if}}
    {{#if afFieldValueIs name="file_type" value="rectangular_gene_expression"}}
      {{> afQuickField name="normalization"}}
    {{/if}}
    <div class="form-group">
      <button class="btn btn-primary set-file-options">
        Apply
      </button>
    </div>
  {{/autoForm}}
</template>
